#!/bin/bash -eu

username=`docker info 2>/dev/null | grep Username | cut -c11-`
sti="file://`pwd`/sti"
gc=

function check {
  echo "  * Testing $1 ..."
  sti build . $username/ghc-network test -s $sti
  gc="$gc $(docker inspect -f '{{.Id}}' test)"
  docker run --name test -d -p 8080:8080 test >/dev/null
  sleep 0.01
  if curl -s localhost:8080 | grep -q $2; then
    docker rm -f test >/dev/null
    return
  fi
  echo "  * $1 FAILED"
  exit 1
}

function check_build {
  echo "  * Testing $1 ..."
  sti build . $username/ghc-network test -s $sti | tee ../build.log
  gc="$gc $(docker inspect -f '{{.Id}}' test)"
  grep -q $2 ../build.log && return
  echo "  * $1 FAILED"
  exit 1
}

#build image
cd image
./build network

#create app
cd ..
rm -rf server-test
cp -r server server-test
cd server-test
check "create app" "Welcome"

#cabal flags
cp Main.hs test.hs
sed -i 's/Welcome/Greetings/' test.hs
echo "Flag A" >>server.cabal
sed -i 's/main-is: *Main.hs/if flag(a) {main-is:Main.hs} else {main-is:test.hs}/' server.cabal
echo "b" >.sti/markers/cabal_flags
check "enable flags" "Welcome"
echo "-a" >>.sti/markers/cabal_flags
check "unset flag" "Greetings"
rm .sti/markers/cabal_flags

#run_tests
touch .sti/markers/run_tests
echo "main = return ()" >test.hs
echo "test-suite test
  type:exitcode-stdio-1.0
  main-is:test.hs
  build-depends:groups" >>server.cabal
  #check that test dependencies are installed
check "run_tests" "Welcome"
rm .sti/markers/run_tests

#hooks
echo "sed -i 's/Welcome/Greetings/' Main.hs" >.sti/hooks/pre_build
chmod +x .sti/hooks/pre_build
check "pre_build hook" "Greetings"
rm .sti/hooks/pre_build

#preserve installed packages
sed -i 's/network/network,groups/' server.cabal
check_build "use previously installed package" "-v \"groups\""

#sequential build
touch .sti/markers/sequential
check_build "sequential build" "Compiling"
rm .sti/markers/sequential

#cabal_update
touch .sti/markers/cabal_update
check_build "cabal_update" "Downloading"
rm .sti/markers/cabal_update

#logs
touch .sti/markers/logs
check_build "logs" "Compiling"
rm .sti/markers/logs

echo "PASSED"

#clear up
cd ..
rm -r server-test build.log
docker rmi $gc >/dev/null

docker run --rm $username/ghc-network cat /opt/sti/provides